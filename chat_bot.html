<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat Bot ‚Äî Website Builder</title>
    <style>
      :root{--bg:#f6f8fb;--card:#ffffff;--user:#0b7cff;--ai:#dff4ea;--muted:#4b5563;color-scheme:light}
      body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#ffffff 0%, #f6f8fb 100%);margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
      .app{width:100%;max-width:900px;background:var(--card);border-radius:12px;box-shadow:0 8px 30px rgba(16,24,40,.06);overflow:hidden;display:flex;flex-direction:column}
      header{padding:18px 20px;border-bottom:1px solid rgba(15,23,42,.06);display:flex;align-items:center;gap:12px}
      header h1{margin:0;font-size:16px;color:#0f1720}
      header p{margin:0;color:var(--muted);font-size:13px}
      .chat{padding:20px;flex:1;overflow:auto;display:flex;flex-direction:column;gap:12px}
      .msg{max-width:82%;padding:12px 14px;border-radius:10px;color:#0f1720;line-height:1.45;border:1px solid rgba(15,23,42,.06);background:#f8fafc}
      .msg.user{margin-left:auto;background:linear-gradient(90deg,var(--user),#186de4);color:#fff}
      .msg.ai{margin-right:auto;background:linear-gradient(90deg,#dff4ea,var(--ai));color:#0f1720}
      .meta{font-size:12px;color:var(--muted);margin-top:6px}
      .input{display:flex;padding:12px;border-top:1px solid rgba(15,23,42,.06);gap:8px;align-items:flex-end}
      .input textarea{flex:1;min-height:48px;max-height:150px;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,.06);background:transparent;color:#0f1720;font-size:14px;resize:vertical}
      .btn{background:var(--user);border:1px solid rgba(11,124,255,.15);color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer}
      .small{font-size:13px;padding:8px 10px}
      pre{background:#f3f4f6;color:#0f1720;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap;border:1px solid rgba(15,23,42,.04)}
      .code-wrap{position:relative}
      .copy-btn{position:absolute;right:8px;top:8px;border:none;background:rgba(11,124,255,.9);color:#fff;padding:6px 8px;border-radius:6px;cursor:pointer}
      .hint{padding:12px 18px;border-top:1px solid rgba(15,23,42,.06);color:var(--muted);font-size:13px}
      .examples{display:flex;gap:8px}
      .chip{background:rgba(15,23,42,.03);padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:600}
    </style>
  </head>
  <body>
    <div class="app" role="application" aria-label="Chat bot for website generation">
      <header>
        <div style="flex:1">
          <h1>Website Builder Chat ü§ñ</h1>
          <p>Type your requirements and the AI will respond with page code and explanations.</p>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="clear" class="btn small">Clear</button>
          <a class="btn small" href="index.php" style="text-decoration:none">Open Demo</a>
        </div>
      </header>

      <div class="chat" id="chat"></div>

      <div class="input">
        <textarea id="input" placeholder="Describe the website or page you want (press Enter to send). e.g. 'Build a 3-page portfolio site with homepage, projects, contact pages'" rows="2"></textarea>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;min-width:92px">
          <div id="charCount" style="font-size:12px;color:var(--muted);">0 / 3000</div>
          <button id="send" class="btn">Send</button>
        </div>
      </div>

      <div class="hint">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="examples">
            <div class="chip" data-example="A single-page product landing page with hero, features and signup form">Landing page</div>
            <div class="chip" data-example="A portfolio site with home, projects, and contact pages. Minimal, responsive, and uses CSS Grid">Portfolio</div>
            <div class="chip" data-example="A blog index and a post page with simple markdown rendering">Blog</div>
          </div>
          <small style="color:var(--muted)">Model: <strong>claude-sonnet-4.5</strong></small>
        </div>
      </div>
    </div>

    <script src="https://js.puter.com/v2/"></script>
    <script>
      const chatEl = document.getElementById('chat');
      const input = document.getElementById('input');
      const sendBtn = document.getElementById('send');
      const clearBtn = document.getElementById('clear');
      const chips = document.querySelectorAll('.chip');
      const MAX_INPUT_CHARS = 3000; // configurable client-side limit
      const charCountEl = document.getElementById('charCount');

      function updateCharCount(){
        const len = input.value.length;
        charCountEl.textContent = `${len} / ${MAX_INPUT_CHARS}`;
        if(len > MAX_INPUT_CHARS){
          charCountEl.style.color = '#ef4444'; // red
          sendBtn.disabled = true;
          sendBtn.style.opacity = '0.6';
        } else {
          charCountEl.style.color = 'var(--muted)';
          sendBtn.disabled = false;
          sendBtn.style.opacity = '1';
        }
      }

      // show a system-like AI message guiding the user to reduce the input
      function showLengthWarning(){
        addMessage('ai', `<div>‚ö†Ô∏è Your message exceeds the maximum allowed length of ${MAX_INPUT_CHARS} characters. Please shorten it or split it into multiple messages (send them one-by-one). I will wait for a shorter input to continue.</div><div class="meta">System</div>`);
        input.focus();
      }

      input.addEventListener('input', updateCharCount);
      // initialize display
      updateCharCount();

      // A short prefatory instruction to guide the assistant when the user asks for "build" tasks
      const systemPreface = `You are an expert web developer. When the user requests a website, respond with an overview of the suggested structure followed by the complete source code for each file. Use fenced code blocks (\`\`\`) with filenames or languages. If the user's message exceeds ${MAX_INPUT_CHARS} characters, do NOT attempt to generate the full answer; instead, reply with a short message asking the user to reduce or split the input into multiple parts so you can help iteratively.`;

      function escapeHtml(s){
        return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      }

      function addMessage(kind, htmlContent, opts={}){
        const el = document.createElement('div');
        el.className = 'msg ' + kind;
        el.setAttribute('data-kind', kind);
        // Accept htmlContent as already-safe HTML string (we escape where needed)
        el.innerHTML = htmlContent;
        chatEl.appendChild(el);
        chatEl.scrollTop = chatEl.scrollHeight - chatEl.clientHeight;
        return el;
      }

      async function handleSend(){
        const textRaw = input.value;
        const text = textRaw.trim();
        if(!text) return;
        // enforce client-side length limit
        if(textRaw.length > MAX_INPUT_CHARS){
          showLengthWarning();
          return;
        }
        // append user message
        addMessage('user', `<div>${escapeHtml(text)}</div><div class="meta">You</div>`);
        input.value = '';
        updateCharCount();

        // prepare an AI message container
        const aiNode = addMessage('ai', `<div class="ai-content"></div>`);
        const contentNode = aiNode.querySelector('.ai-content');

        // create a small indicator
        let typing = document.createElement('div');
        typing.textContent = '‚è≥ Generating...';
        typing.style.opacity = '0.6';
        typing.style.marginTop = '6px';
        contentNode.appendChild(typing);

        // call puter.ai.chat with streaming
        try{
          const prompt = `${systemPreface}\n\nUser: ${text}`;
          const chat_resp = await puter.ai.chat(prompt, { model: 'claude-sonnet-4.5', stream: true });

          // Remove typing and instead stream content
          contentNode.removeChild(typing);

          // streaming: handle code fences
          let inCode = false; // whether we are inside a code fence
          let codeEl = null;
          let codeLang = '';
          let stopStreaming = false;

          for await (const part of chat_resp){
            if(!part) continue;
            const chunk = part?.text ?? '';
            if(chunk.length === 0) continue;

              // heuristic: detect explicit signals about limits (more conservative than matching a single common word)
            const low = chunk.toLowerCase();
            if(!inCode && (low.includes('exceed') || low.includes('exceeded') || low.includes('too long') || low.includes('token limit') || low.includes('context window') || low.includes('context length') || (low.includes('token') && low.includes('limit')))){
              contentNode.insertAdjacentHTML('beforeend', `<div style="color:#b45309">‚ö†Ô∏è The assistant indicates the message is too long or exceeded limits. Please shorten your input or split it into multiple messages and try again.</div>`);
              stopStreaming = true;
              break;
            }

            // Simple parser for triple-backtick fences
            let i = 0;
            while(i < chunk.length){
              // find next fence in the remainder
              const fenceIndex = chunk.indexOf('```', i);
              if(fenceIndex === -1){
                // no more fences: append remainder to current mode
                const textChunk = chunk.slice(i);
                if(inCode){
                  codeEl.textContent += textChunk; // preserve raw text
                } else {
                  // append escaped HTML with line breaks
                  const escaped = escapeHtml(textChunk).replaceAll('\n','<br>');
                  contentNode.insertAdjacentHTML('beforeend', escaped);
                }
                break;
              }

              // there is a fence
              // append up to fence
              const before = chunk.slice(i, fenceIndex);
              if(before){
                if(inCode) codeEl.textContent += before;
                else contentNode.insertAdjacentHTML('beforeend', escapeHtml(before).replaceAll('\n','<br>'));
              }

              // toggle fence
              // check if this is opening or closing by checking inCode
              if(!inCode){
                // opening: try to get language immediately after fence
                const rest = chunk.slice(fenceIndex + 3);
                const langMatch = rest.match(/^\s*([a-zA-Z0-9-]*)\s*\n?/);
                codeLang = langMatch ? (langMatch[1] || '') : '';
                // create code block
                const wrapper = document.createElement('div');
                wrapper.className = 'code-wrap';
                codeEl = document.createElement('pre');
                codeEl.className = 'code-block';
                wrapper.appendChild(codeEl);
                // add copy button
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy';
                copyBtn.addEventListener('click', ()=>{navigator.clipboard.writeText(codeEl.textContent)});
                wrapper.appendChild(copyBtn);
                contentNode.appendChild(wrapper);
                inCode = true;

                // advance i past fence and optional language and newline
                if(langMatch){
                  i = fenceIndex + 3 + langMatch[0].length;
                } else {
                  i = fenceIndex + 3;
                }
              } else {
                // closing fence: end code block
                inCode = false;
                codeEl = null;
                codeLang = '';
                i = fenceIndex + 3;
              }
            }

            // keep scroll pinned to bottom while streaming
            chatEl.scrollTop = chatEl.scrollHeight - chatEl.clientHeight;
          }

          // after streaming done, add small meta (unless we stopped due to limits)
          if(stopStreaming){
            contentNode.insertAdjacentHTML('beforeend', '<div class="meta">Stopped ‚Äî reduce your input and retry</div>');
          } else {
            contentNode.insertAdjacentHTML('beforeend', '<div class="meta">Claude Sonnet 4.5</div>');
          }
        }catch(err){
          // Ensure typing indicator is cleared on errors
          try{ if(contentNode.contains(typing)) contentNode.removeChild(typing); }catch(e){}
          contentNode.insertAdjacentHTML('beforeend', `<div style="color:#ffb4b4">Error: ${escapeHtml(String(err))}</div>`);
        }

        chatEl.scrollTop = chatEl.scrollHeight;
      }

      sendBtn.addEventListener('click', handleSend);

      input.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          if(input.value.length > MAX_INPUT_CHARS){ showLengthWarning(); return; }
          handleSend();
        }
      });

      clearBtn.addEventListener('click', ()=>{chatEl.innerHTML=''});

      chips.forEach(c => c.addEventListener('click', ()=>{input.value = c.dataset.example; input.focus();}));

      // small accessibility helper: focus input on page load
      window.addEventListener('load', ()=>input.focus());
    </script>
  </body>
</html>